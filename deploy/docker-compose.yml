services:
  livekit:
    image: livekit/livekit-server:latest
    command: ["--config", "/livekit.yaml"]
    restart: unless-stopped
    ports:
      - "7880:7880"
      - "7881:7881/tcp"
      - "3478:3478/udp"
      - "${LIVEKIT_RTC_PORT_RANGE_START:-50000}-${LIVEKIT_RTC_PORT_RANGE_END:-50010}:${LIVEKIT_RTC_PORT_RANGE_START:-50000}-${LIVEKIT_RTC_PORT_RANGE_END:-50010}/udp"
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-devsecret00000000000000000000000000000000}"
    volumes:
      - ./livekit.yaml:/livekit.yaml:ro
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 7880 || exit 1"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 2s

  server:
    build:
      context: ../apps/server
      dockerfile: Dockerfile
    network_mode: host
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
    environment:
      SERVER_ADDR: "127.0.0.1:8080"
      SERVER_NAME: "${SERVER_NAME:-Local Server}"
      SERVER_PUBLIC_KEY_FINGERPRINT_EMOJI: "${SERVER_PUBLIC_KEY_FINGERPRINT_EMOJI:-:lock::satellite:}"
      DATA_DIR: "/workspace/data"
      DB_PATH: "${DB_PATH:-server.db}"
      WEB_DIST_DIR: "${WEB_DIST_DIR:-}"
      ADMIN_TOKEN: "${ADMIN_TOKEN:-devadmin}"
      SERVER_PUBLIC_BASE_URL: "${SERVER_PUBLIC_BASE_URL:-http://localhost:8088}"
      LIVEKIT_URL: "${LIVEKIT_URL:-http://127.0.0.1:7880}"
      LIVEKIT_API_KEY: "${LIVEKIT_API_KEY:-devkey}"
      LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET:-devsecret00000000000000000000000000000000}"
    volumes:
      - ../apps/server/data:/workspace/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/health >/dev/null || exit 1"]
      interval: 2s
      timeout: 2s
      retries: 30
      start_period: 2s

  edge:
    build:
      context: ..
      dockerfile: deploy/nginx/Dockerfile
      args:
        VITE_API_BASE_URL: "${VITE_API_BASE_URL:-/}"
        VITE_CLIENT_MODE: "${VITE_CLIENT_MODE:-single-server-web}"
        VITE_SINGLE_SERVER_BASE_URL: "${VITE_SINGLE_SERVER_BASE_URL:-/}"
    network_mode: host
    restart: unless-stopped
    environment:
      EDGE_HTTP_PORT: "${EDGE_HTTP_PORT:-8088}"
      API_UPSTREAM: "http://127.0.0.1:8080"
    depends_on:
      server:
        condition: service_healthy
